<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradePulse 2049</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <!-- Trading Favicon (Candlestick Chart Icon) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDMyIDMyIj4KICA8cGF0aCBkPSJNMiAxNmMwLTcuNzMyIDYuMjY4LTE0IDE0LTE0czE0IDYuMjY4IDE0IDE0LTE0IDgtMTQtOHptOS0zaC0ydjZhMiAyIDAgMCAwIDIgMnY2aDJ2LTZhMiAyIDAgMCAwIDItMnYtNnptOC0xaC0ydjRhMiAyIDAgMCAwIDIgMnY4aDJ2LTRhMiAyIDAgMCAwIDItMnYtNHoiIGZpbGw9IiM2MGE1ZmEiLz4KICA8cGF0aCBkPSJNMTYgMTJhMiAyIDAgMCAwLTIgMnY0aDR2LTRhMiAyIDAgMCAwLTItMnoiIGZpbGw9IiNhN2IzZmEiLz4KPC9zdmc+">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <style>
        /* Base Theme Variables (Light Mode) */
        :root {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --accent-blue: #60a5fa;
            --accent-mint: #6ee7b7;
            --accent-peach: #fb923c;
            --accent-lavender: #a78bfa;
            --success: #10b981;
            --danger: #ef4444;
            --shadow: rgba(0, 0, 0, 0.05);
            --glow-soft: 0 0 8px rgba(96, 165, 250, 0.2);
            --border: #e5e7eb;
            --holo-blue: rgba(96, 165, 250, 0.15);
        }

        /* Dusk Theme */
        body.dusk-theme {
            --bg-primary: #ede9fe;
            --bg-secondary: #f5f5f5;
            --text-primary: #4b3f72;
            --text-secondary: #7c6e9e;
            --accent-blue: #93c5fd;
            --accent-mint: #6ee7b7;
            --accent-peach: #fb923c;
            --accent-lavender: #c4b5fd;
            --border: #d1d5db;
        }

        /* Morning Theme */
        body.morning-theme {
            --bg-primary: #fefce8;
            --bg-secondary: #fffbeb;
            --text-primary: #5c4033;
            --text-secondary: #8b6f47;
            --accent-blue: #bfdbfe;
            --accent-mint: #6ee7b7;
            --accent-peach: #fb923c;
            --accent-lavender: #ddd6fe;
            --border: #e7e5d4;
        }

        /* Dark Mode */
        body.dark-theme {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --text-primary: #d1d5db;
            --text-secondary: #9ca3af;
            --accent-blue: #60a5fa;
            --accent-mint: #6ee7b7;
            --accent-peach: #fb923c;
            --accent-lavender: #a78bfa;
            --success: #10b981;
            --danger: #ef4444;
            --shadow: rgba(0, 0, 0, 0.2);
            --glow-soft: 0 0 8px rgba(96, 165, 250, 0.3);
            --border: #374151;
            --holo-blue: rgba(96, 165, 250, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* Header */
        header {
            background: var(--bg-secondary);
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(6px);
        }

        header h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.6rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--accent-blue), var(--accent-lavender));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            cursor: pointer;
        }

        .header-controls {
            display: flex;
            gap: 0.4rem;
            align-items: center;
        }

        .header-controls select, .header-controls button {
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.8rem;
            min-width: 40px;
            text-align: center;
        }

        /* Main Layout */
        .simulator-grid {
            max-width: 1920px;
            margin: 1rem auto;
            padding: 0 1rem;
            display: grid;
            grid-template-columns: 4fr 2fr 1fr;
            gap: 0.75rem;
            flex-grow: 1;
        }

        /* Card Styling */
        .card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 10px var(--shadow);
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border);
            opacity: 0;
        }

        .card h2 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent-lavender);
            margin-bottom: 0.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card h2::after {
            content: '\f078';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            font-size: 0.7rem;
            opacity: 0.6;
        }

        .card.collapsed h2::after {
            transform: rotate(180deg);
        }

        .card.collapsed > *:not(h2) { display: none; }

        /* Price Display */
        .price-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            position: relative;
        }

        .price-display::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 30%;
            height: 2px;
            background: var(--accent-blue);
            animation: pulseLine 1.5s infinite ease;
        }

        @keyframes pulseLine {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        .price-trend, .live-indicator {
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-weight: 500;
        }

        .trend-up { background: var(--success); color: #ffffff; }
        .trend-down { background: var(--danger); color: #ffffff; }
        .live { background: var(--success); color: #ffffff; }
        .offline { background: var(--danger); color: #ffffff; }

        /* Trading Panel */
        .trading-panel {
            background: var(--bg-secondary);
            padding: 0.75rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px var(--shadow);
            position: sticky;
            bottom: 0.5rem;
            margin: 0.5rem auto;
            max-width: 1400px;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            border: 1px solid var(--border);
            backdrop-filter: blur(4px);
        }

        .trading-panel input, .trading-panel select {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            width: 120px;
            font-size: 0.8rem;
        }

        .trading-panel input:focus, .trading-panel select:focus {
            border-color: var(--accent-blue);
            box-shadow: var(--glow-soft);
            outline: none;
        }

        /* Button Styling */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-lavender));
            color: #ffffff;
            box-shadow: 0 1px 8px var(--shadow);
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.85rem;
        }

        .btn-buy { background: linear-gradient(135deg, var(--success), var(--accent-mint)); }
        .btn-sell { background: linear-gradient(135deg, var(--danger), var(--accent-peach)); }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: var(--bg-secondary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border-left: 3px solid var(--accent-blue);
            box-shadow: 0 2px 10px var(--shadow);
            display: flex;
            align-items: center;
            gap: 0.4rem;
            z-index: 1000;
            backdrop-filter: blur(4px);
            font-size: 0.85rem;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            max-width: 700px;
            width: 90%;
            box-shadow: 0 4px 15px var(--shadow);
            position: relative;
            border: 1px solid var(--border);
            backdrop-filter: blur(6px);
        }

        .modal-content h3 {
            font-family: 'Orbitron', sans-serif;
            margin-bottom: 0.5rem;
            color: var(--accent-lavender);
            font-size: 1.1rem;
        }

        .modal-content a, .modal-content p {
            color: var(--text-primary);
            text-decoration: none;
            display: block;
            margin: 0.4rem 0;
            font-size: 0.85rem;
        }

        .modal-content a:hover {
            color: var(--accent-blue);
        }

        .modal-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .modal-close:hover {
            color: var(--accent-blue);
        }

        /* Dashboard Toggle */
        .dashboard-toggle {
            position: fixed;
            top: 0.5rem;
            right: 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 1px 6px var(--shadow);
        }

        /* Footer */
        footer {
            background: var(--bg-secondary);
            padding: 0.5rem;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.8rem;
            box-shadow: 0 -1px 6px var(--shadow);
            margin-top: auto;
            position: relative;
        }

        footer::before {
            content: 'TradePulse v2.0.49';
            position: absolute;
            top: 50%;
            right: 0.5rem;
            transform: translateY(-50%);
            font-size: 0.7rem;
            opacity: 0.5;
        }

        /* Responsive Design */
        @media (max-width: 1400px) {
            .simulator-grid { grid-template-columns: 3fr 2fr; }
            .card:nth-child(3) { grid-column: span 2; }
        }

        @media (max-width: 900px) {
            .simulator-grid { grid-template-columns: 1fr; }
            .trading-panel { flex-direction: column; align-items: stretch; }
            .trading-panel input, .trading-panel select { width: 100%; }
            .price-display { font-size: 1.6rem; }
            .header-controls { flex-wrap: wrap; gap: 0.3rem; }
            .dashboard-toggle { top: 3.5rem; }
        }

        .hidden { display: none; }
        .list-item { display: flex; justify-content: space-between; margin: 0.3rem 0; font-size: 0.8rem; }
        .order-list { margin-top: 0.5rem; font-size: 0.8rem; max-height: 150px; overflow-y: auto; }
        .order-list div { padding: 0.3rem 0; border-bottom: 1px solid var(--border); }
    </style>
</head>
<body>
    <!-- Simulator Page -->
    <div class="simulator" id="simulatorPage">
        <header>
            <h1>TradePulse 2049</h1>
            <div class="header-controls">
                <select id="stockSelect" aria-label="Select Stock">
                    <option value="AAPL">Apple (AAPL)</option>
                    <option value="GOOGL">Google (GOOGL)</option>
                    <option value="TSLA">Tesla (TSLA)</option>
                    <option value="BTC">Bitcoin (BTC)</option>
                    <option value="ETH">Ethereum (ETH)</option>
                    <option value="SPCE">Virgin Galactic (SPCE)</option>
                </select>
                <select id="themeSelect" aria-label="Select Theme">
                    <option value="default">Light</option>
                    <option value="dusk">Dusk</option>
                    <option value="morning">Morning</option>
                    <option value="dark">Dark</option>
                </select>
                <button id="newsBtn" aria-label="Market News"><i class="fas fa-newspaper"></i></button>
                <button id="aiPredictBtn" aria-label="AI Prediction"><i class="fas fa-brain"></i></button>
                <button id="ordersBtn" aria-label="View Orders"><i class="fas fa-list"></i></button>
                <button id="soundToggle" aria-label="Toggle Sound"><i class="fas fa-volume-up"></i></button>
                <button id="settingsBtn" aria-label="Settings"><i class="fas fa-cog"></i></button>
            </div>
        </header>

        <div class="dashboard-toggle" id="dashboardToggle" aria-label="Toggle Dashboard">
            <i class="fas fa-eye"></i>
        </div>

        <div class="simulator-grid" id="simulatorGrid">
            <div class="card chart-card">
                <div class="price-display">
                    $<span id="currentPrice">100.00</span>
                    <span id="priceTrend" class="price-trend"></span>
                    <span id="liveStatus" class="live-indicator offline">Offline</span>
                </div>
                <canvas id="priceChart" aria-label="Stock Price Chart"></canvas>
            </div>

            <div class="card portfolio-card">
                <h2>Portfolio</h2>
                <div class="list-item"><span>Cash:</span> $<span id="cash">10000.00</span></div>
                <div class="list-item"><span>Stocks:</span> <span id="stocks">0</span></div>
                <div class="list-item"><span>Total Value:</span> $<span id="totalValue">10000.00</span></div>
                <div class="list-item"><span>Profit/Loss:</span> $<span id="profitLoss">0.00</span></div>
                <div class="list-item"><span>Volatility:</span> <span id="volatility">0.00%</span></div>
                <canvas id="performanceChart" aria-label="Portfolio Performance Chart" style="margin-top: 0.5rem;"></canvas>
            </div>

            <div class="card analytics-card">
                <h2>Analytics & Sentiment</h2>
                <div class="list-item"><span>Sharpe Ratio:</span> <span id="sharpeRatio">0.00</span></div>
                <div class="list-item"><span>Bullish Sentiment:</span> <span id="bullish">50%</span></div>
                <div class="list-item"><span>Bearish Sentiment:</span> <span id="bearish">50%</span></div>
                <button class="btn" id="voteBullish"><span><i class="fas fa-thumbs-up"></i> Bullish</span></button>
                <button class="btn btn-sell" id="voteBearish"><span><i class="fas fa-thumbs-down"></i> Bearish</span></button>
                <h2>Leaderboard</h2>
                <div id="leaderboard"></div>
            </div>
        </div>

        <div class="trading-panel">
            <input type="number" id="quantity" min="1" value="1" placeholder="Quantity" aria-label="Quantity">
            <select id="orderType" aria-label="Order Type">
                <option value="market">Market</option>
                <option value="limit">Limit</option>
                <option value="stop-loss">Stop-Loss</option>
                <option value="take-profit">Take-Profit</option>
                <option value="short">Short Sell</option>
                <option value="oco">OCO</option>
            </select>
            <input type="number" id="limitPrice" class="hidden" placeholder="Limit Price" step="0.01" aria-label="Limit Price">
            <input type="number" id="stopLossPrice" class="hidden" placeholder="Stop-Loss" step="0.01" aria-label="Stop-Loss Price">
            <input type="number" id="takeProfitPrice" class="hidden" placeholder="Take-Profit" step="0.01" aria-label="Take-Profit Price">
            <input type="number" id="leverage" class="hidden" min="1" max="10" value="1" placeholder="Leverage" aria-label="Leverage">
            <button class="btn btn-buy" id="buyBtn"><span><i class="fas fa-arrow-up"></i> Buy</span></button>
            <button class="btn btn-sell" id="sellBtn"><span><i class="fas fa-arrow-down"></i> Sell</span></button>
            <button class="btn" id="exportBtn"><span><i class="fas fa-download"></i> Export</span></button>
            <input type="file" id="importInput" accept=".json" class="hidden" aria-label="Import Portfolio">
            <button class="btn" id="importBtn"><span><i class="fas fa-upload"></i> Import</span></button>
        </div>

        <div class="toast" id="toast" role="alert" aria-live="assertive">
            <i class="fas fa-info-circle"></i> <span id="toastMessage"></span>
        </div>

        <div class="modal" id="newsModal">
            <div class="modal-content">
                <button class="modal-close" id="closeNewsModal">×</button>
                <h3>Market News</h3>
                <div id="newsContent"></div>
            </div>
        </div>

        <div class="modal" id="ordersModal">
            <div class="modal-content">
                <button class="modal-close" id="closeOrdersModal">×</button>
                <h3>Active Orders</h3>
                <div id="ordersContent"></div>
            </div>
        </div>

        <div class="modal" id="settingsModal">
            <div class="modal-content">
                <button class="modal-close" id="closeSettingsModal">×</button>
                <h3>Settings</h3>
                <div id="settingsContent">
                    <p><label><input type="checkbox" id="autoRefresh" checked> Auto-Refresh Price</label></p>
                    <p><label>Refresh Interval (s): <input type="number" id="refreshInterval" min="5" max="60" value="10"></label></p>
                    <p><label>Username: <input type="text" id="usernameInput" value="Guest"></label></p>
                </div>
            </div>
        </div>

        <footer>
            © 2049 TradePulse by yashnigam07. All rights reserved.
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <script src="config.js"></script>
    <script>
        // Utility Functions
        const $ = (id) => document.getElementById(id);
        const showToast = (message, type = 'info') => {
            const toast = $('toast');
            $('toastMessage').innerHTML = message;
            toast.className = `toast ${type}`;
            gsap.fromTo(toast, { x: '120%', opacity: 0 }, { x: '0%', opacity: 1, duration: 0.5, ease: 'power2.out', onComplete: () => toast.classList.add('show') });
            setTimeout(() => gsap.to(toast, { x: '120%', opacity: 0, duration: 0.5, ease: 'power2.in', onComplete: () => toast.classList.remove('show') }), 4000);
            if (soundEnabled) playSound(type);
        };

        const notify = (title, body) => {
            if (Notification.permission === 'granted') new Notification(title, { body });
            else if (Notification.permission !== 'denied') Notification.requestPermission().then(p => p === 'granted' && new Notification(title, { body }));
        };

        const showModal = (id, content) => {
            const modal = $(id);
            $(`${id.replace('Modal', 'Content')}`).innerHTML = content;
            modal.classList.add('show');
            gsap.fromTo(modal, { opacity: 0, scale: 0.95 }, { opacity: 1, scale: 1, duration: 0.4, ease: 'back.out(1.2)' });
        };

        const hideModal = (id) => {
            const modal = $(id);
            gsap.to(modal, {
                opacity: 0,
                scale: 0.95,
                duration: 0.3,
                ease: 'power2.in',
                onComplete: () => modal.classList.remove('show')
            });
        };

        let soundEnabled = true;
        const sounds = {
            success: new Audio('https://www.soundjay.com/buttons/beep-01a.mp3'),
            error: new Audio('https://www.soundjay.com/buttons/beep-02.mp3'),
            warning: new Audio('https://www.soundjay.com/buttons/beep-03.mp3'),
            info: new Audio('https://www.soundjay.com/buttons/beep-04.mp3')
        };

        const playSound = (type) => {
            sounds[type]?.play().catch(e => console.log('Sound playback failed:', e));
        };

        // Simulator Class
        class StockSimulator {
            constructor() {
                this.username = localStorage.getItem('username') || "Guest";
                this.cash = 10000;
                this.portfolio = {};
                this.currentStock = 'AAPL';
                this.stockPrices = { AAPL: 100, GOOGL: 100, TSLA: 100, BTC: 100, ETH: 50, SPCE: 20 };
                this.price = 100;
                this.priceHistory = [{ time: new Date().toLocaleTimeString(), price: 100 }];
                this.lastPrice = 100;
                this.limitOrders = [];
                this.stopLossOrders = [];
                this.takeProfitOrders = [];
                this.shortPositions = [];
                this.ocoOrders = [];
                this.sentiment = { bullish: 50, bearish: 50, votes: { bullish: 0, bearish: 0 } };
                this.leaderboard = JSON.parse(localStorage.getItem('leaderboard') || '{}');
                this.isLive = false;
                this.apiCalls = 0;
                this.maxApiCalls = 5;
                this.performanceHistory = [{ time: new Date().toLocaleTimeString(), value: 10000 }];
                this.apiKey = config.apiKey;
                this.aiPrediction = null;
                this.newsFeed = [];
                this.holoDashboard = false;
                this.autoRefresh = true;
                this.refreshInterval = 10000;
                this.orderHistory = [];
                this.init();
            }

            async init() {
                if (!this.apiKey) throw new Error('API key not found in config.js');
                this.setupUI();
                this.setupCharts();
                this.loadData();
                this.startSimulation();
                this.fetchNews();
                Notification.requestPermission();
                this.applyTheme();
                this.toggleCollapsibleCards();
                this.animateUI();
            }

            setupUI() {
                $('simulatorPage').classList.remove('hidden');
                $('stockSelect').value = this.currentStock;
                $('usernameInput').value = this.username;

                $('buyBtn').addEventListener('click', () => this.handleBuy());
                $('sellBtn').addEventListener('click', () => this.handleSell());
                $('stockSelect').addEventListener('change', () => this.changeStock());
                $('themeSelect').addEventListener('change', () => this.changeTheme());
                $('orderType').addEventListener('change', () => this.toggleOrderInputs());
                $('voteBullish').addEventListener('click', () => this.vote('bullish'));
                $('voteBearish').addEventListener('click', () => this.vote('bearish'));
                $('exportBtn').addEventListener('click', () => this.exportData());
                $('importBtn').addEventListener('click', () => $('importInput').click());
                $('importInput').addEventListener('change', (e) => this.importData(e));
                $('newsBtn').addEventListener('click', () => this.showNews());
                $('aiPredictBtn').addEventListener('click', () => this.aiPredict());
                $('ordersBtn').addEventListener('click', () => this.showOrders());
                $('settingsBtn').addEventListener('click', () => this.showSettings());
                $('closeNewsModal').addEventListener('click', () => hideModal('newsModal'));
                $('closeOrdersModal').addEventListener('click', () => hideModal('ordersModal'));
                $('closeSettingsModal').addEventListener('click', () => hideModal('settingsModal'));
                $('newsModal').addEventListener('click', (e) => e.target === $('newsModal') && hideModal('newsModal'));
                $('ordersModal').addEventListener('click', (e) => e.target === $('ordersModal') && hideModal('ordersModal'));
                $('settingsModal').addEventListener('click', (e) => e.target === $('settingsModal') && hideModal('settingsModal'));
                $('soundToggle').addEventListener('click', () => this.toggleSound());
                $('dashboardToggle').addEventListener('click', () => this.toggleHoloDashboard());
                $('simulatorPage').querySelector('h1').addEventListener('click', () => this.resetView());
                $('autoRefresh').addEventListener('change', () => this.toggleAutoRefresh());
                $('refreshInterval').addEventListener('change', () => this.updateRefreshInterval());
                $('usernameInput').addEventListener('change', () => this.updateUsername());

                // GSAP Button Hover Animations
                document.querySelectorAll('.btn, .header-controls button, .dashboard-toggle').forEach(btn => {
                    btn.addEventListener('mouseenter', () => gsap.to(btn, { scale: 1.05, duration: 0.2, ease: 'power2.out' }));
                    btn.addEventListener('mouseleave', () => gsap.to(btn, { scale: 1, duration: 0.2, ease: 'power2.in' }));
                });
            }

            animateUI() {
                // Card Entrance Animation
                gsap.from('.card', {
                    opacity: 0,
                    y: 20,
                    stagger: 0.1,
                    duration: 0.6,
                    ease: 'power3.out',
                    onComplete: () => document.querySelectorAll('.card').forEach(card => card.style.opacity = 1)
                });

                // Header Title Animation
                gsap.from('header h1', { opacity: 0, x: -20, duration: 0.8, ease: 'power3.out' });

                // Header Controls Animation
                gsap.from('.header-controls > *', { opacity: 0, y: -10, stagger: 0.05, duration: 0.5, ease: 'power2.out' });

                // Trading Panel Animation
                gsap.from('.trading-panel > *', { opacity: 0, y: 10, stagger: 0.05, duration: 0.5, ease: 'power2.out', delay: 0.3 });
            }

            toggleOrderInputs() {
                const type = $('orderType').value;
                $('limitPrice').classList.toggle('hidden', type !== 'limit');
                $('stopLossPrice').classList.toggle('hidden', type !== 'stop-loss' && type !== 'oco');
                $('takeProfitPrice').classList.toggle('hidden', type !== 'take-profit' && type !== 'oco');
                $('leverage').classList.toggle('hidden', type !== 'short');
            }

            toggleCollapsibleCards() {
                document.querySelectorAll('.card h2').forEach(h2 => {
                    h2.addEventListener('click', () => {
                        const card = h2.parentElement;
                        card.classList.toggle('collapsed');
                        gsap.to(card.children, { height: card.classList.contains('collapsed') ? 0 : 'auto', duration: 0.3, ease: 'power2.inOut' });
                    });
                });
            }

            toggleSound() {
                soundEnabled = !soundEnabled;
                $('soundToggle').innerHTML = `<i class="fas fa-volume-${soundEnabled ? 'up' : 'mute'}"></i>`;
                showToast(`Sound ${soundEnabled ? 'enabled' : 'disabled'}`, 'info');
            }

            toggleHoloDashboard() {
                this.holoDashboard = !this.holoDashboard;
                const grid = $('simulatorGrid');
                gsap.to(grid, {
                    rotateX: this.holoDashboard ? 8 : 0,
                    z: this.holoDashboard ? 40 : 0,
                    duration: 0.5,
                    ease: 'power3.inOut'
                });
                $('dashboardToggle').innerHTML = `<i class="fas fa-${this.holoDashboard ? 'eye-slash' : 'eye'}"></i>`;
                showToast(`Holo-Dashboard ${this.holoDashboard ? 'activated' : 'deactivated'}`, 'info');
            }

            resetView() {
                this.holoDashboard = false;
                gsap.to($('simulatorGrid'), { rotateX: 0, z: 0, duration: 0.5, ease: 'power3.inOut' });
                $('dashboardToggle').innerHTML = '<i class="fas fa-eye"></i>';
                showToast('View reset to default', 'info');
            }

            toggleAutoRefresh() {
                this.autoRefresh = $('autoRefresh').checked;
                showToast(`Auto-refresh ${this.autoRefresh ? 'enabled' : 'disabled'}`, 'info');
            }

            updateRefreshInterval() {
                const interval = parseInt($('refreshInterval').value) * 1000;
                if (interval >= 5000 && interval <= 60000) {
                    this.refreshInterval = interval;
                    this.restartSimulation();
                    showToast(`Refresh interval set to ${interval / 1000}s`, 'info');
                } else {
                    showToast('Interval must be between 5 and 60 seconds', 'error');
                    $('refreshInterval').value = this.refreshInterval / 1000;
                }
            }

            updateUsername() {
                this.username = $('usernameInput').value || 'Guest';
                localStorage.setItem('username', this.username);
                this.updateLeaderboard();
                showToast(`Username updated to ${this.username}`, 'success');
            }

            setupCharts() {
                this.priceChart = new Chart($('priceChart'), {
                    type: 'line',
                    data: {
                        labels: this.priceHistory.map(h => h.time),
                        datasets: [
                            { label: 'Price', data: this.priceHistory.map(h => h.price), borderColor: 'var(--accent-blue)', fill: true, backgroundColor: 'rgba(96, 165, 250, 0.1)', tension: 0.4 },
                            { label: 'EMA(10)', data: this.calculateEMA(10), borderColor: 'var(--accent-peach)', fill: false, tension: 0.4 },
                            { label: 'RSI', data: this.calculateRSI(14), borderColor: 'var(--accent-lavender)', yAxisID: 'rsi', fill: false, tension: 0.4 },
                            { label: 'Bollinger Upper', data: this.calculateBollingerBands(20).upper, borderColor: 'var(--text-secondary)', fill: false, tension: 0.4, borderDash: [5, 5] },
                            { label: 'Bollinger Lower', data: this.calculateBollingerBands(20).lower, borderColor: 'var(--text-secondary)', fill: false, tension: 0.4, borderDash: [5, 5] }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { ticks: { callback: v => `$${v.toFixed(2)}` }, grid: { color: 'rgba(0, 0, 0, 0.03)' } },
                            rsi: { position: 'right', min: 0, max: 100, ticks: { color: 'var(--accent-lavender)' }, grid: { display: false } },
                            x: { ticks: { maxTicksLimit: 12 }, grid: { color: 'rgba(0, 0, 0, 0.03)' } }
                        },
                        plugins: {
                            legend: { position: 'top', labels: { color: 'var(--text-primary)', font: { size: 11 } } },
                            zoom: {
                                zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'xy' },
                                pan: { enabled: true, mode: 'xy' }
                            }
                        }
                    }
                });

                this.performanceChart = new Chart($('performanceChart'), {
                    type: 'line',
                    data: {
                        labels: this.performanceHistory.map(h => h.time),
                        datasets: [{ label: 'Portfolio Value', data: this.performanceHistory.map(h => h.value), borderColor: 'var(--accent-peach)', fill: true, backgroundColor: 'rgba(251, 146, 60, 0.1)' }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { ticks: { callback: v => `$${v.toFixed(2)}` } }, x: { ticks: { maxTicksLimit: 12 } } },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            calculateEMA(period) {
                const prices = this.priceHistory.map(h => h.price);
                const k = 2 / (period + 1);
                const ema = [prices[0]];
                for (let i = 1; i < prices.length; i++) ema.push(prices[i] * k + ema[i - 1] * (1 - k));
                return ema;
            }

            calculateRSI(period) {
                const prices = this.priceHistory.map(h => h.price);
                if (prices.length < period + 1) return prices.map(() => null);
                const gains = [], losses = [];
                for (let i = 1; i < prices.length; i++) {
                    const diff = prices[i] - prices[i - 1];
                    gains.push(diff > 0 ? diff : 0);
                    losses.push(diff < 0 ? -diff : 0);
                }
                let avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
                let avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;
                const rs = avgGain / avgLoss || 0;
                const rsi = [null, ...Array(period - 1).fill(null), rs ? 100 - (100 / (1 + rs)) : 50];
                for (let i = period; i < gains.length; i++) {
                    avgGain = (avgGain * (period - 1) + gains[i]) / period;
                    avgLoss = (avgLoss * (period - 1) + losses[i]) / period;
                    rsi.push(avgGain / avgLoss ? 100 - (100 / (1 + avgGain / avgLoss)) : 50);
                }
                return rsi;
            }

            calculateBollingerBands(period) {
                const prices = this.priceHistory.map(h => h.price);
                const sma = prices.map((_, i) => i < period - 1 ? null : prices.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0) / period);
                const upper = [], lower = [];
                for (let i = 0; i < prices.length; i++) {
                    if (i < period - 1) {
                        upper.push(null);
                        lower.push(null);
                    } else {
                        const slice = prices.slice(i - period + 1, i + 1);
                        const mean = sma[i];
                        const stdDev = Math.sqrt(slice.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / period);
                        upper.push(mean + 2 * stdDev);
                        lower.push(mean - 2 * stdDev);
                    }
                }
                return { upper, lower };
            }

            startSimulation() {
                this.priceInterval = setInterval(() => this.autoRefresh && this.updatePrice(), this.refreshInterval);
                this.darkPoolInterval = setInterval(() => this.simulateDarkPool(), 20000);
                this.eventInterval = setInterval(() => this.simulateMarketEvent(), 30000);
                this.updateUI();
            }

            restartSimulation() {
                clearInterval(this.priceInterval);
                this.priceInterval = setInterval(() => this.autoRefresh && this.updatePrice(), this.refreshInterval);
            }

            async updatePrice() {
                if (this.apiCalls < this.maxApiCalls) {
                    try {
                        const symbol = this.currentStock === 'BTC' ? 'BTCUSD' : this.currentStock === 'ETH' ? 'ETHUSD' : this.currentStock;
                        const res = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${this.apiKey}`);
                        const data = await res.json();
                        if (data['Global Quote'] && data['Global Quote']['05. price']) {
                            this.lastPrice = this.price;
                            this.price = parseFloat(data['Global Quote']['05. price']);
                            this.stockPrices[this.currentStock] = this.price;
                            this.isLive = true;
                            this.apiCalls++;
                            showToast(`Live price updated for ${this.currentStock}`, 'success');
                        } else throw new Error('Invalid API response');
                    } catch (e) {
                        console.error('API fetch failed:', e);
                        this.simulatePrice();
                        showToast('Failed to fetch live data, using simulation', 'warning');
                    }
                } else {
                    this.simulatePrice();
                    showToast('API rate limit reached, using simulation', 'warning');
                }
                this.updateUI();
            }

            simulatePrice() {
                this.lastPrice = this.price;
                const volatility = this.currentStock === 'BTC' || this.currentStock === 'ETH' ? 0.05 : 0.02;
                this.price *= (1 + (Math.random() - 0.5) * volatility);
                this.price = Math.max(10, this.price.toFixed(2));
                this.stockPrices[this.currentStock] = this.price;
                this.isLive = false;
            }

            simulateDarkPool() {
                const impact = (Math.random() - 0.5) * 0.03;
                this.price *= (1 + impact);
                showToast(`Dark pool trade: ${impact > 0 ? 'Buy' : 'Sell'} pressure`, impact > 0 ? 'success' : 'error');
                this.updateUI();
            }

            simulateMarketEvent() {
                const events = [
                    { msg: `${this.currentStock} CEO announces breakthrough!`, impact: 0.05 },
                    { msg: `Regulatory concerns hit ${this.currentStock}.`, impact: -0.04 },
                    { msg: `Market rumors swirl around ${this.currentStock}.`, impact: (Math.random() - 0.5) * 0.03 },
                    { msg: `${this.currentStock} earnings exceed expectations!`, impact: 0.06 },
                    { msg: `Geopolitical tensions affect ${this.currentStock}.`, impact: -0.03 }
                ];
                const event = events[Math.floor(Math.random() * events.length)];
                this.price *= (1 + event.impact);
                showToast(event.msg, event.impact > 0 ? 'success' : 'error');
                this.updateUI();
            }

            updateUI() {
                $('currentPrice').textContent = this.price.toFixed(2);
                const change = ((this.price - this.lastPrice) / this.lastPrice * 100).toFixed(2);
                $('priceTrend').textContent = `${change > 0 ? '+' : ''}${change}%`;
                $('priceTrend').className = `price-trend ${change >= 0 ? 'trend-up' : 'trend-down'}`;
                $('liveStatus').textContent = this.isLive ? 'Live' : 'Offline';
                $('liveStatus').className = `live-indicator ${this.isLive ? 'live' : 'offline'}`;

                this.priceHistory.push({ time: new Date().toLocaleTimeString(), price: this.price });
                if (this.priceHistory.length > 60) this.priceHistory.shift();
                this.priceChart.data.labels = this.priceHistory.map(h => h.time);
                this.priceChart.data.datasets[0].data = this.priceHistory.map(h => h.price);
                this.priceChart.data.datasets[1].data = this.calculateEMA(10);
                this.priceChart.data.datasets[2].data = this.calculateRSI(14);
                const bb = this.calculateBollingerBands(20);
                this.priceChart.data.datasets[3].data = bb.upper;
                this.priceChart.data.datasets[4].data = bb.lower;
                this.priceChart.update();

                const totalStocks = this.portfolio[this.currentStock]?.qty || 0;
                const stockValue = totalStocks * this.price;
                const totalValue = this.cash + stockValue + this.calculateShortValue();
                const profitLoss = stockValue - (this.portfolio[this.currentStock]?.totalSpent || 0);

                $('cash').textContent = this.cash.toFixed(2);
                $('stocks').textContent = totalStocks;
                $('totalValue').textContent = totalValue.toFixed(2);
                $('profitLoss').textContent = profitLoss.toFixed(2);
                $('profitLoss').style.color = profitLoss >= 0 ? 'var(--success)' : 'var(--danger)';
                this.calculateVolatility();
                this.updatePerformance(totalValue);
                this.updateAnalytics();
                this.updateLeaderboard();
                this.checkOrders();
            }

            calculateVolatility() {
                const prices = this.priceHistory.map(h => h.price);
                if (prices.length < 2) return $('volatility').textContent = '0.00%';
                const returns = prices.slice(1).map((p, i) => (p - prices[i]) / prices[i]);
                const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
                const variance = returns.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / returns.length;
                const vol = (Math.sqrt(variance) * Math.sqrt(252) * 100).toFixed(2);
                $('volatility').textContent = `${vol}%`;
            }

            calculateSharpeRatio() {
                const returns = this.performanceHistory.map((h, i) => i === 0 ? 0 : (h.value - this.performanceHistory[i - 1].value) / this.performanceHistory[i - 1].value);
                if (returns.length < 2) return 0;
                const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
                const stdDev = Math.sqrt(returns.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / returns.length);
                return stdDev === 0 ? 0 : (mean / stdDev * Math.sqrt(252)).toFixed(2);
            }

            updatePerformance(totalValue) {
                this.performanceHistory.push({ time: new Date().toLocaleTimeString(), value: totalValue });
                if (this.performanceHistory.length > 60) this.performanceHistory.shift();
                this.performanceChart.data.labels = this.performanceHistory.map(h => h.time);
                this.performanceChart.data.datasets[0].data = this.performanceHistory.map(h => h.value);
                this.performanceChart.update();
            }

            updateAnalytics() {
                $('sharpeRatio').textContent = this.calculateSharpeRatio();
                const totalVotes = this.sentiment.votes.bullish + this.sentiment.votes.bearish || 1;
                $('bullish').textContent = `${(this.sentiment.votes.bullish / totalVotes * 100).toFixed(0)}%`;
                $('bearish').textContent = `${(this.sentiment.votes.bearish / totalVotes * 100).toFixed(0)}%`;
            }

            updateLeaderboard() {
                const totalValue = this.cash + Object.entries(this.portfolio).reduce((sum, [s, d]) => sum + d.qty * (this.stockPrices[s] || 100), 0);
                this.leaderboard[this.username] = totalValue;
                localStorage.setItem('leaderboard', JSON.stringify(this.leaderboard));
                const sorted = Object.entries(this.leaderboard).sort((a, b) => b[1] - a[1]).slice(0, 5);
                $('leaderboard').innerHTML = sorted.map(([user, val]) => `<div class="list-item"><span>${user}</span><span>$${val.toFixed(2)}</span></div>`).join('');
            }

            handleBuy() {
                const qty = parseInt($('quantity').value);
                const type = $('orderType').value;
                const price = type === 'limit' ? parseFloat($('limitPrice').value) : type === 'stop-loss' ? parseFloat($('stopLossPrice').value) : type === 'take-profit' ? parseFloat($('takeProfitPrice').value) : this.price;
                const leverage = type === 'short' ? parseInt($('leverage').value) : 1;
                const cost = qty * price;

                if (!this.validateOrder(qty, cost, 'buy')) return;

                const order = { type, qty, price, leverage, timestamp: new Date().toLocaleString(), status: 'Pending' };
                if (type === 'limit' && this.price > price) {
                    this.limitOrders.push(order);
                    showToast(`Limit buy placed at $${price.toFixed(2)}`, 'info');
                } else if (type === 'stop-loss') {
                    this.stopLossOrders.push(order);
                    showToast(`Stop-loss set at $${price.toFixed(2)}`, 'info');
                } else if (type === 'take-profit') {
                    this.takeProfitOrders.push(order);
                    showToast(`Take-profit set at $${price.toFixed(2)}`, 'info');
                } else if (type === 'short') {
                    order.entryPrice = this.price;
                    order.margin = cost / leverage;
                    this.shortPositions.push(order);
                    this.cash -= order.margin;
                    showToast(`Short position opened: ${qty} ${this.currentStock} @ ${leverage}x`, 'info');
                } else if (type === 'oco') {
                    order.stopLoss = parseFloat($('stopLossPrice').value);
                    order.takeProfit = parseFloat($('takeProfitPrice').value);
                    this.ocoOrders.push(order);
                    showToast(`OCO order placed`, 'info');
                } else {
                    this.cash -= cost;
                    this.portfolio[this.currentStock] = this.portfolio[this.currentStock] || { qty: 0, totalSpent: 0 };
                    this.portfolio[this.currentStock].qty += qty;
                    this.portfolio[this.currentStock].totalSpent += cost;
                    order.status = 'Executed';
                    this.orderHistory.push(order);
                    showToast(`Bought ${qty} ${this.currentStock} for $${cost.toFixed(2)}`, 'success');
                }
                this.saveData();
                this.updateUI();
            }

            handleSell() {
                const qty = parseInt($('quantity').value);
                const type = $('orderType').value;
                const price = type === 'limit' ? parseFloat($('limitPrice').value) : type === 'stop-loss' ? parseFloat($('stopLossPrice').value) : type === 'take-profit' ? parseFloat($('takeProfitPrice').value) : this.price;
                const revenue = qty * price;

                if (!this.portfolio[this.currentStock] || this.portfolio[this.currentStock].qty < qty) {
                    showToast('Not enough stocks to sell', 'error');
                    return;
                }

                const order = { type, qty, price, timestamp: new Date().toLocaleString(), status: 'Pending' };
                if (type === 'limit' && this.price < price) {
                    this.limitOrders.push(order);
                    showToast(`Limit sell placed at $${price.toFixed(2)}`, 'info');
                } else if (type === 'stop-loss') {
                    this.stopLossOrders.push(order);
                    showToast(`Stop-loss set at $${price.toFixed(2)}`, 'info');
                } else if (type === 'take-profit') {
                    this.takeProfitOrders.push(order);
                    showToast(`Take-profit set at $${price.toFixed(2)}`, 'info');
                } else if (type === 'oco') {
                    order.stopLoss = parseFloat($('stopLossPrice').value);
                    order.takeProfit = parseFloat($('takeProfitPrice').value);
                    this.ocoOrders.push(order);
                    showToast(`OCO order placed`, 'info');
                } else {
                    this.cash += revenue;
                    const avgCost = this.portfolio[this.currentStock].totalSpent / this.portfolio[this.currentStock].qty;
                    this.portfolio[this.currentStock].qty -= qty;
                    this.portfolio[this.currentStock].totalSpent -= avgCost * qty;
                    if (this.portfolio[this.currentStock].qty === 0) delete this.portfolio[this.currentStock];
                    order.status = 'Executed';
                    this.orderHistory.push(order);
                    showToast(`Sold ${qty} ${this.currentStock} for $${revenue.toFixed(2)}`, 'success');
                }
                this.saveData();
                this.updateUI();
            }

            validateOrder(qty, amount, type) {
                if (isNaN(qty) || qty <= 0 || !Number.isInteger(qty)) {
                    showToast('Quantity must be a positive integer', 'error');
                    return false;
                }
                if (type === 'buy' && this.cash < amount) {
                    showToast('Insufficient funds', 'error');
                    return false;
                }
                return true;
            }

            checkOrders() {
                this.limitOrders = this.limitOrders.filter(o => {
                    if (o.type === 'buy' && this.price <= o.price) {
                        this.cash -= o.qty * o.price;
                        this.portfolio[this.currentStock] = this.portfolio[this.currentStock] || { qty: 0, totalSpent: 0 };
                        this.portfolio[this.currentStock].qty += o.qty;
                        this.portfolio[this.currentStock].totalSpent += o.qty * o.price;
                        o.status = 'Executed';
                        this.orderHistory.push(o);
                        notify('Limit Buy Executed', `${o.qty} ${this.currentStock} @ $${o.price.toFixed(2)}`);
                        showToast(`Limit buy executed: ${o.qty} ${this.currentStock} @ $${o.price.toFixed(2)}`, 'success');
                        return false;
                    } else if (o.type === 'sell' && this.price >= o.price) {
                        this.cash += o.qty * o.price;
                        const avgCost = this.portfolio[this.currentStock].totalSpent / this.portfolio[this.currentStock].qty;
                        this.portfolio[this.currentStock].qty -= o.qty;
                        this.portfolio[this.currentStock].totalSpent -= avgCost * o.qty;
                        if (this.portfolio[this.currentStock].qty === 0) delete this.portfolio[this.currentStock];
                        o.status = 'Executed';
                        this.orderHistory.push(o);
                        notify('Limit Sell Executed', `${o.qty} ${this.currentStock} @ $${o.price.toFixed(2)}`);
                        showToast(`Limit sell executed: ${o.qty} ${this.currentStock} @ $${o.price.toFixed(2)}`, 'success');
                        return false;
                    }
                    return true;
                });

                this.stopLossOrders = this.stopLossOrders.filter(o => {
                    if (this.price <= o.price) {
                        this.cash += o.qty * this.price;
                        const avgCost = this.portfolio[this.currentStock].totalSpent / this.portfolio[this.currentStock].qty;
                        this.portfolio[this.currentStock].qty -= o.qty;
                        this.portfolio[this.currentStock].totalSpent -= avgCost * o.qty;
                        if (this.portfolio[this.currentStock].qty === 0) delete this.portfolio[this.currentStock];
                        o.status = 'Executed';
                        this.orderHistory.push(o);
                        notify('Stop-Loss Triggered', `${o.qty} ${this.currentStock} @ $${this.price.toFixed(2)}`);
                        showToast(`Stop-loss triggered: ${o.qty} ${this.currentStock} @ $${this.price.toFixed(2)}`, 'error');
                        return false;
                    }
                    return true;
                });

                this.takeProfitOrders = this.takeProfitOrders.filter(o => {
                    if (this.price >= o.price) {
                        this.cash += o.qty * this.price;
                        const avgCost = this.portfolio[this.currentStock].totalSpent / this.portfolio[this.currentStock].qty;
                        this.portfolio[this.currentStock].qty -= o.qty;
                        this.portfolio[this.currentStock].totalSpent -= avgCost * o.qty;
                        if (this.portfolio[this.currentStock].qty === 0) delete this.portfolio[this.currentStock];
                        o.status = 'Executed';
                        this.orderHistory.push(o);
                        notify('Take-Profit Triggered', `${o.qty} ${this.currentStock} @ $${this.price.toFixed(2)}`);
                        showToast(`Take-profit triggered: ${o.qty} ${this.currentStock} @ $${this.price.toFixed(2)}`, 'success');
                        return false;
                    }
                    return true;
                });

                this.ocoOrders = this.ocoOrders.filter(o => {
                    if (this.price <= o.stopLoss) {
                        this.cash += o.qty * this.price;
                        const avgCost = this.portfolio[this.currentStock].totalSpent / this.portfolio[this.currentStock].qty;
                        this.portfolio[this.currentStock].qty -= o.qty;
                        this.portfolio[this.currentStock].totalSpent -= avgCost * o.qty;
                        if (this.portfolio[this.currentStock].qty === 0) delete this.portfolio[this.currentStock];
                        o.status = 'Executed (Stop-Loss)';
                        this.orderHistory.push(o);
                        notify('OCO Stop-Loss Triggered', `${o.qty} ${this.currentStock} @ $${this.price.toFixed(2)}`);
                        showToast(`OCO stop-loss triggered: ${o.qty} ${this.currentStock} @ $${this.price.toFixed(2)}`, 'error');
                        return false;
                    } else if (this.price >= o.takeProfit) {
                        this.cash += o.qty * this.price;
                        const avgCost = this.portfolio[this.currentStock].totalSpent / this.portfolio[this.currentStock].qty;
                        this.portfolio[this.currentStock].qty -= o.qty;
                        this.portfolio[this.currentStock].totalSpent -= avgCost * o.qty;
                        if (this.portfolio[this.currentStock].qty === 0) delete this.portfolio[this.currentStock];
                        o.status = 'Executed (Take-Profit)';
                        this.orderHistory.push(o);
                        notify('OCO Take-Profit Triggered', `${o.qty} ${this.currentStock} @ $${this.price.toFixed(2)}`);
                        showToast(`OCO take-profit triggered: ${o.qty} ${this.currentStock} @ $${this.price.toFixed(2)}`, 'success');
                        return false;
                    }
                    return true;
                });

                this.shortPositions = this.shortPositions.filter(p => {
                    const loss = (this.price - p.entryPrice) * p.qty * p.leverage;
                    if (loss > p.margin * 0.9) {
                        this.cash -= loss;
                        p.status = 'Liquidated';
                        this.orderHistory.push(p);
                        showToast(`Short position liquidated: Loss $${loss.toFixed(2)}`, 'error');
                        notify('Short Liquidation', `Loss: $${loss.toFixed(2)}`);
                        return false;
                    }
                    return true;
                });
            }

            calculateShortValue() {
                return this.shortPositions.reduce((sum, p) => sum + (p.entryPrice - this.price) * p.qty * p.leverage, 0);
            }

            vote(type) {
                this.sentiment.votes[type]++;
                this.updateAnalytics();
                showToast(`Voted ${type}`, 'success');
            }

            changeStock() {
                this.currentStock = $('stockSelect').value;
                this.price = this.stockPrices[this.currentStock] || 100;
                this.priceHistory = [{ time: new Date().toLocaleTimeString(), price: this.price }];
                this.apiCalls = 0;
                this.updatePrice();
                showToast(`Switched to ${this.currentStock}`, 'info');
            }

            changeTheme() {
                const theme = $('themeSelect').value;
                document.body.className = `${theme}-theme`;
                localStorage.setItem('theme', theme);
                this.priceChart.update();
                this.performanceChart.update();
            }

            applyTheme() {
                const theme = localStorage.getItem('theme') || 'default';
                $('themeSelect').value = theme;
                document.body.className = `${theme}-theme`;
            }

            saveData() {
                localStorage.setItem(`simulator_${this.username}`, JSON.stringify({
                    cash: this.cash,
                    portfolio: this.portfolio,
                    currentStock: this.currentStock,
                    limitOrders: this.limitOrders,
                    stopLossOrders: this.stopLossOrders,
                    takeProfitOrders: this.takeProfitOrders,
                    shortPositions: this.shortPositions,
                    ocoOrders: this.ocoOrders,
                    stockPrices: this.stockPrices,
                    sentiment: this.sentiment,
                    performanceHistory: this.performanceHistory,
                    orderHistory: this.orderHistory
                }));
            }

            loadData() {
                const data = JSON.parse(localStorage.getItem(`simulator_${this.username}`));
                if (data) {
                    Object.assign(this, data);
                    $('stockSelect').value = this.currentStock;
                    this.updateUI();
                }
            }

            exportData() {
                const data = { cash: this.cash, portfolio: this.portfolio, orderHistory: this.orderHistory };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `portfolio_${this.username}_${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showToast('Portfolio exported', 'success');
            }

            importData(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        this.cash = data.cash;
                        this.portfolio = data.portfolio;
                        this.orderHistory = data.orderHistory || [];
                        this.saveData();
                        this.updateUI();
                        showToast('Portfolio imported', 'success');
                    } catch (err) {
                        showToast('Invalid file format', 'error');
                    }
                };
                reader.readAsText(file);
            }

            async fetchNews() {
                try {
                    this.newsFeed = [
                        { title: `${this.currentStock} Surges Amid New Developments`, url: '#' },
                        { title: 'Market Analysts Predict Bullish Trend for Tech Stocks', url: '#' },
                        { title: 'Crypto Volatility Expected This Week', url: '#' },
                        { title: `${this.currentStock} Partners with AI Firm`, url: '#' }
                    ];
                } catch (e) {
                    console.error('Failed to fetch news:', e);
                    showToast('Unable to fetch news', 'warning');
                }
            }

            showNews() {
                const newsList = this.newsFeed.map(n => `<a href="${n.url}" target="_blank">${n.title}</a>`).join('<br>');
                showModal('newsModal', newsList);
            }

            showOrders() {
                const allOrders = [
                    ...this.limitOrders.map(o => ({ type: `Limit ${o.type}`, qty: o.qty, price: o.price, status: o.status, timestamp: o.timestamp })),
                    ...this.stopLossOrders.map(o => ({ type: 'Stop-Loss', qty: o.qty, price: o.price, status: o.status, timestamp: o.timestamp })),
                    ...this.takeProfitOrders.map(o => ({ type: 'Take-Profit', qty: o.qty, price: o.price, status: o.status, timestamp: o.timestamp })),
                    ...this.shortPositions.map(o => ({ type: 'Short', qty: o.qty, price: o.entryPrice, leverage: o.leverage, status: o.status, timestamp: o.timestamp })),
                    ...this.ocoOrders.map(o => ({ type: 'OCO', qty: o.qty, stopLoss: o.stopLoss, takeProfit: o.takeProfit, status: o.status, timestamp: o.timestamp })),
                    ...this.orderHistory.map(o => o)
                ];
                const content = allOrders.length ? `<div class="order-list">${allOrders.map(o => `<div>${o.type} - ${o.qty} @ $${o.price || o.stopLoss || o.takeProfit} ${o.leverage ? `@ ${o.leverage}x` : ''} - ${o.status} (${o.timestamp})</div>`).join('')}</div>` : '<p>No active orders</p>';
                showModal('ordersModal', content);
            }

            showSettings() {
                showModal('settingsModal', $('settingsContent').innerHTML);
            }

            aiPredict() {
                const trend = this.priceHistory.slice(-10).reduce((acc, h, i, arr) => acc + (i > 0 ? h.price - arr[i - 1].price : 0), 0);
                this.aiPrediction = trend > 0 ? 'Bullish' : trend < 0 ? 'Bearish' : 'Neutral';
                showToast(`AI Prediction: ${this.aiPrediction} trend expected in next 24h`, 'success');
            }
        }

        // Start App
        document.addEventListener('DOMContentLoaded', () => {
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                showToast('Warning: Use HTTPS for security', 'warning');
            }
            new StockSimulator();
        });
    </script>
</body>
</html>