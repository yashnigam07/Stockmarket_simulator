<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Stock Trader 2025</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Theme Variables */
        :root {
            --bg-primary: #0d0d1a;
            --bg-secondary: #1a1a2e;
            --text-primary: #e0e0f5;
            --accent-purple: #9b59b6;
            --accent-cyan: #00e5ff;
            --accent-orange: #ff8c00;
            --success: #00e676;
            --danger: #ff5252;
            --neutral: #7a8299;
            --shadow: rgba(0, 0, 0, 0.5);
            --glow: 0 0 10px var(--accent-cyan);
            transition: all 0.5s ease;
        }

        body.light-theme {
            --bg-primary: #f0f4f8;
            --bg-secondary: #ffffff;
            --text-primary: #1a1a2e;
            --accent-purple: #6b48ff;
            --accent-cyan: #00b7eb;
            --neutral: #4a4a4a;
        }

        body.minimal-theme {
            --bg-primary: #e0e0e0;
            --bg-secondary: #ffffff;
            --text-primary: #333333;
            --accent-purple: #555555;
            --accent-cyan: #777777;
            --accent-orange: #999999;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto Mono', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            background: var(--bg-secondary);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 15px var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(45deg, var(--accent-purple), var(--accent-cyan));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .header-controls select, .header-controls button {
            padding: 0.5rem 1rem;
            border: 1px solid var(--accent-purple);
            border-radius: 8px;
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .header-controls select:hover, .header-controls button:hover {
            border-color: var(--accent-cyan);
            box-shadow: var(--glow);
        }

        #clock {
            font-size: 0.9rem;
            color: var(--neutral);
        }

        /* Main Layout */
        .simulator-grid {
            max-width: 1600px;
            margin: 2rem auto;
            padding: 0 1rem;
            display: grid;
            grid-template-columns: 3fr 2fr 1fr;
            gap: 1.5rem;
            flex-grow: 1;
        }

        /* Card Styling */
        .card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px var(--shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 6px 25px var(--glow);
        }

        .card h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--accent-cyan);
            margin-bottom: 1rem;
            cursor: pointer;
        }

        .card.collapsed > *:not(h2) { display: none; }

        /* Price Display */
        .price-display {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .price-trend, .live-indicator {
            font-size: 1rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
        }

        .trend-up { background: rgba(0, 230, 118, 0.2); color: var(--success); }
        .trend-down { background: rgba(255, 82, 82, 0.2); color: var(--danger); }
        .live { background: rgba(0, 230, 118, 0.2); color: var(--success); }
        .offline { background: rgba(255, 82, 82, 0.2); color: var(--danger); }

        /* Chart Controls */
        .chart-controls {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .chart-controls label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Timeframe Controls */
        .timeframe-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .timeframe-btn {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            background: var(--bg-primary);
            border: 1px solid var(--accent-cyan);
        }

        .timeframe-btn.active {
            background: var(--accent-cyan);
            color: var(--bg-primary);
        }

        /* Gradient for Chart */
        canvas#priceChart {
            background: linear-gradient(to bottom, rgba(0, 229, 255, 0.05), rgba(0, 0, 0, 0.1));
            border-radius: 8px;
        }

        /* Trading Panel */
        .trading-panel {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow);
            position: sticky;
            bottom: 1rem;
            margin: 1rem auto;
            max-width: 1000px;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            transition: transform 0.3s ease;
        }

        .trading-panel.collapsed {
            transform: translateY(100%);
        }

        .toggle-panel {
            position: absolute;
            top: -2.5rem;
            right: 1rem;
            padding: 0.5rem;
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .trading-panel.collapsed .toggle-panel i {
            transform: rotate(180deg);
        }

        .trading-panel input, .trading-panel select {
            padding: 0.75rem;
            border: 1px solid var(--accent-purple);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            width: 120px;
            transition: all 0.3s ease;
        }

        .trading-panel input:focus, .trading-panel select:focus {
            border-color: var(--accent-cyan);
            box-shadow: var(--glow);
            outline: none;
        }

        /* Button Styling */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));
            color: var(--text-primary);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s ease, height 0.6s ease;
        }

        .btn:hover::before {
            width: 200%;
            height: 200%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px var(--glow);
        }

        .btn-buy { background: linear-gradient(135deg, var(--success), #00c853); }
        .btn-sell { background: linear-gradient(135deg, var(--danger), #d81b60); }
        .btn span { display: flex; align-items: center; gap: 0.5rem; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: var(--bg-secondary);
            padding: 1rem 2rem;
            border-radius: 8px;
            border-left: 4px solid var(--accent-cyan);
            box-shadow: 0 4px 15px var(--shadow);
            transform: translateX(120%);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .toast.show { transform: translateX(0); }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        .toast.warning { border-left-color: var(--accent-orange); }

        /* Sticky Analytics Card */
        .analytics-card {
            position: sticky;
            top: 1rem;
            max-height: calc(100vh - 2rem);
            overflow-y: auto;
        }

        /* Save Indicator */
        .save-indicator {
            position: fixed;
            top: 1rem;
            right: 1rem;
            font-size: 0.8rem;
            color: var(--success);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .save-indicator.active {
            opacity: 1;
        }

        /* Footer */
        footer {
            background: var(--bg-secondary);
            padding: 1rem;
            text-align: center;
            color: var(--neutral);
            font-size: 0.9rem;
            box-shadow: 0 -2px 15px var(--shadow);
            margin-top: auto;
        }

        /* Collapsible Lists */
        .list-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--neutral);
            font-size: 0.9rem;
        }

        #tradeLog {
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.85rem;
            margin-top: 1rem;
        }

        #tradeLog::-webkit-scrollbar {
            width: 8px;
        }

        #tradeLog::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        #tradeLog::-webkit-scrollbar-thumb {
            background: var(--accent-cyan);
            border-radius: 4px;
        }

        #tradeLog::-webkit-scrollbar-thumb:hover {
            background: var(--accent-purple);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .simulator-grid { grid-template-columns: 1fr 1fr; }
            .analytics-card { grid-column: span 2; position: static; }
        }

        @media (max-width: 800px) {
            .simulator-grid { grid-template-columns: 1fr; }
            .trading-panel { position: fixed; bottom: 0; left: 0; right: 0; margin: 0; border-radius: 12px 12px 0 0; }
            .trading-panel input, .trading-panel select { width: 100%; }
            .price-display { font-size: 2rem; }
            .header-controls { flex-direction: column; gap: 0.5rem; }
            .chart-controls, .timeframe-controls { flex-direction: column; }
        }

        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="simulator" id="simulatorPage">
        <header>
            <h1>Quantum Stock Trader 2025</h1>
            <div class="header-controls">
                <span id="clock"></span>
                <select id="stockSelect" aria-label="Select Stock">
                    <option value="AAPL">Apple (AAPL)</option>
                    <option value="GOOGL">Google (GOOGL)</option>
                    <option value="TSLA">Tesla (TSLA)</option>
                    <option value="BTC">Bitcoin (BTC)</option>
                </select>
                <select id="themeSelect" aria-label="Select Theme">
                    <option value="cyberpunk">Cyberpunk</option>
                    <option value="light">Light</option>
                    <option value="minimal">Minimal</option>
                </select>
                <button class="btn" id="resetBtn"><span><i class="fas fa-redo"></i> Reset</span></button>
            </div>
        </header>

        <div class="simulator-grid">
            <div class="card chart-card">
                <div class="price-display">
                    $<span id="currentPrice">100.00</span>
                    <span id="priceTrend" class="price-trend"></span>
                    <span id="liveStatus" class="live-indicator offline">Offline</span>
                </div>
                <div class="chart-controls">
                    <label><input type="checkbox" id="toggleEMA" checked> EMA(10)</label>
                    <label><input type="checkbox" id="toggleRSI" checked> RSI</label>
                    <label><input type="checkbox" id="toggleBB" checked> Bollinger Bands</label>
                </div>
                <div class="timeframe-controls">
                    <button class="btn timeframe-btn" data-timeframe="1m">1M</button>
                    <button class="btn timeframe-btn" data-timeframe="5m">5M</button>
                    <button class="btn timeframe-btn" data-timeframe="1d">1D</button>
                </div>
                <canvas id="priceChart" aria-label="Stock Price Chart"></canvas>
            </div>

            <div class="card portfolio-card">
                <h2>Portfolio</h2>
                <div class="list-item"><span>Cash:</span> $<span id="cash">10000.00</span></div>
                <div class="list-item"><span>Stocks:</span> <span id="stocks">0</span></div>
                <div class="list-item"><span>Total Value:</span> $<span id="totalValue">10000.00</span></div>
                <div class="list-item"><span>Profit/Loss:</span> $<span id="profitLoss">0.00</span></div>
                <div class="list-item"><span>Volatility:</span> <span id="volatility">0.00%</span></div>
                <canvas id="performanceChart" aria-label="Portfolio Performance Chart" style="margin-top: 1rem;"></canvas>
                <canvas id="portfolioPie" aria-label="Portfolio Breakdown" style="margin-top: 1rem; max-height: 200px;"></canvas>
                <h2>Trade Log</h2>
                <div id="tradeLog"></div>
            </div>

            <div class="card analytics-card">
                <h2>Analytics & Social</h2>
                <div class="list-item"><span>Sharpe Ratio:</span> <span id="sharpeRatio">0.00</span></div>
                <div class="list-item"><span>Bullish Sentiment:</span> <span id="bullish">50%</span></div>
                <div class="list-item"><span>Bearish Sentiment:</span> <span id="bearish">50%</span></div>
                <button class="btn" id="voteBullish"><span><i class="fas fa-thumbs-up"></i> Bullish</span></button>
                <button class="btn btn-sell" id="voteBearish"><span><i class="fas fa-thumbs-down"></i> Bearish</span></button>
                <h2>Leaderboard</h2>
                <div id="leaderboard"></div>
            </div>
        </div>

        <div class="trading-panel" id="tradingPanel">
            <button class="btn toggle-panel" id="toggleTradingPanel"><i class="fas fa-chevron-up"></i></button>
            <input type="number" id="quantity" min="1" value="1" placeholder="Quantity" aria-label="Quantity">
            <select id="orderType" aria-label="Order Type">
                <option value="market">Market</option>
                <option value="limit">Limit</option>
                <option value="stop-loss">Stop-Loss</option>
                <option value="take-profit">Take-Profit</option>
                <option value="short">Short Sell</option>
            </select>
            <input type="number" id="limitPrice" class="hidden" placeholder="Limit Price" step="0.01" aria-label="Limit Price">
            <input type="number" id="stopLossPrice" class="hidden" placeholder="Stop-Loss" step="0.01" aria-label="Stop-Loss Price">
            <input type="number" id="takeProfitPrice" class="hidden" placeholder="Take-Profit" step="0.01" aria-label="Take-Profit Price">
            <input type="number" id="leverage" class="hidden" min="1" max="10" value="1" placeholder="Leverage" aria-label="Leverage">
            <button class="btn btn-buy" id="buyBtn"><span><i class="fas fa-arrow-up"></i> Buy</span></button>
            <button class="btn btn-sell" id="sellBtn"><span><i class="fas fa-arrow-down"></i> Sell</span></button>
            <button class="btn" id="exportBtn"><span><i class="fas fa-download"></i> Export</span></button>
            <input type="file" id="importInput" accept=".json" class="hidden" aria-label="Import Portfolio">
            <button class="btn" id="importBtn"><span><i class="fas fa-upload"></i> Import</span></button>
        </div>

        <div class="toast" id="toast" role="alert" aria-live="assertive">
            <i class="fas fa-info-circle"></i> <span id="toastMessage"></span>
        </div>

        <div class="save-indicator" id="saveIndicator">Saved</div>

        <footer>
            © 2025 Quantum Stock Trader by yashnigam07. All rights reserved.
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <script src="config.js"></script>
    <script>
        // Utility Functions
        const $ = (id) => document.getElementById(id);
        const showToast = (message, type = 'info') => {
            const toast = $('toast');
            $('toastMessage').textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        };

        const showSaveIndicator = () => {
            const indicator = $('saveIndicator');
            indicator.classList.add('active');
            setTimeout(() => indicator.classList.remove('active'), 1000);
        };

        const notify = (title, body) => {
            if (Notification.permission === 'granted') new Notification(title, { body });
            else if (Notification.permission !== 'denied') Notification.requestPermission().then(p => p === 'granted' && new Notification(title, { body }));
        };

        const formatDateTime = () => {
            const now = new Date('2025-03-15T00:00:00');
            now.setSeconds(now.getSeconds() + Math.floor(performance.now() / 1000));
            return now.toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' });
        };

        const debounce = (func, wait) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        };

        // Simulator Class
        class StockSimulator {
            constructor() {
                this.cash = 10000;
                this.portfolio = {};
                this.currentStock = 'AAPL';
                this.stockPrices = { AAPL: 100, GOOGL: 100, TSLA: 100, BTC: 100 };
                this.price = 100;
                this.priceHistory = [{ time: new Date().toLocaleTimeString(), price: 100, volume: 500 }];
                this.lastPrice = 100;
                this.limitOrders = [];
                this.stopLossOrders = [];
                this.takeProfitOrders = [];
                this.shortPositions = [];
                this.sentiment = { bullish: 50, bearish: 50, votes: { bullish: 0, bearish: 0 } };
                this.leaderboard = JSON.parse(localStorage.getItem('leaderboard') || '{}');
                this.isLive = false;
                this.apiCalls = 0;
                this.maxApiCalls = 5;
                this.performanceHistory = [{ time: new Date().toLocaleTimeString(), value: 10000 }];
                this.tradeLog = [];
                this.apiKey = config.apiKey;
                this.annotations = [];
                this.init();
            }

            async init() {
                if (!this.apiKey) throw new Error('API key not found in config.js');
                this.setupUI();
                this.setupCharts();
                this.loadData();
                this.startSimulation();
                Notification.requestPermission();
                this.applyTheme();
                this.toggleCollapsibleCards();
                this.updateClock();
            }

            setupUI() {
                $('buyBtn').addEventListener('click', () => this.handleBuy());
                $('sellBtn').addEventListener('click', () => this.handleSell());
                $('stockSelect').addEventListener('change', () => this.changeStock());
                $('themeSelect').addEventListener('change', () => this.changeTheme());
                $('orderType').addEventListener('change', () => this.toggleOrderInputs());
                $('voteBullish').addEventListener('click', () => this.vote('bullish'));
                $('voteBearish').addEventListener('click', () => this.vote('bearish'));
                $('exportBtn').addEventListener('click', () => this.exportData());
                $('importBtn').addEventListener('click', () => $('importInput').click());
                $('importInput').addEventListener('change', (e) => this.importData(e));
                $('toggleTradingPanel').addEventListener('click', () => {
                    const panel = $('tradingPanel');
                    panel.classList.toggle('collapsed');
                });
                $('resetBtn').addEventListener('click', () => this.resetSimulator());

                $('toggleEMA').addEventListener('change', () => {
                    this.priceChart.data.datasets[1].hidden = !$('toggleEMA').checked;
                    this.priceChart.update();
                });
                $('toggleRSI').addEventListener('change', () => {
                    this.priceChart.data.datasets[2].hidden = !$('toggleRSI').checked;
                    this.priceChart.update();
                });
                $('toggleBB').addEventListener('change', () => {
                    this.priceChart.data.datasets[3].hidden = !$('toggleBB').checked;
                    this.priceChart.data.datasets[4].hidden = !$('toggleBB').checked;
                    this.priceChart.update();
                });

                // Keyboard Shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'b' || e.key === 'B') this.handleBuy();
                    if (e.key === 's' || e.key === 'S') this.handleSell();
                });
            }

            toggleOrderInputs() {
                const type = $('orderType').value;
                $('limitPrice').classList.toggle('hidden', type !== 'limit');
                $('stopLossPrice').classList.toggle('hidden', type !== 'stop-loss');
                $('takeProfitPrice').classList.toggle('hidden', type !== 'take-profit');
                $('leverage').classList.toggle('hidden', type !== 'short');
            }

            toggleCollapsibleCards() {
                document.querySelectorAll('.card h2').forEach(h2 => {
                    h2.addEventListener('click', () => h2.parentElement.classList.toggle('collapsed'));
                });
            }

            setupCharts() {
                const ctx = $('priceChart').getContext('2d');
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(0, 229, 255, 0.2)');
                gradient.addColorStop(1, 'rgba(0, 229, 255, 0.05)');

                this.priceChart = new Chart($('priceChart'), {
                    type: 'line',
                    data: {
                        labels: this.priceHistory.map(h => h.time),
                        datasets: [
                            {
                                label: 'Price',
                                data: this.priceHistory.map(h => h.price),
                                borderColor: 'var(--accent-cyan)',
                                backgroundColor: gradient,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0,
                                pointHoverRadius: 5
                            },
                            { label: 'EMA(10)', data: this.calculateEMA(10), borderColor: 'var(--accent-orange)', fill: false, tension: 0.3 },
                            { label: 'RSI', data: this.calculateRSI(14), borderColor: 'var(--accent-purple)', yAxisID: 'rsi', fill: false, tension: 0.3 },
                            { label: 'Bollinger Upper', data: this.calculateBollingerBands(20).upper, borderColor: '#ffffff', fill: false, tension: 0.3, borderDash: [5, 5] },
                            { label: 'Bollinger Lower', data: this.calculateBollingerBands(20).lower, borderColor: '#ffffff', fill: false, tension: 0.3, borderDash: [5, 5] },
                            {
                                label: 'Volume',
                                type: 'bar',
                                data: this.priceHistory.map(h => h.volume),
                                backgroundColor: 'rgba(155, 89, 182, 0.5)',
                                yAxisID: 'volume',
                                barThickness: 10
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        animation: { duration: 1000, easing: 'easeInOutQuad' },
                        scales: {
                            y: { ticks: { callback: v => `$${v.toFixed(2)}` }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                            rsi: { position: 'right', min: 0, max: 100, ticks: { color: 'var(--accent-purple)' }, grid: { display: false } },
                            volume: { position: 'left', max: 2000, display: false },
                            x: { ticks: { maxTicksLimit: 10 }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
                        },
                        plugins: {
                            legend: { position: 'top', labels: { color: 'var(--text-primary)', boxWidth: 20 } },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: (context) => {
                                        const dataset = context.dataset.label;
                                        const value = context.parsed.y;
                                        return `${dataset}: ${dataset === 'Price' ? '$' : ''}${value.toFixed(2)}${dataset === 'RSI' ? '' : dataset === 'Volume' ? ' shares' : ''}`;
                                    }
                                }
                            },
                            zoom: { zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'xy' }, pan: { enabled: true, mode: 'xy' } },
                            annotation: {
                                annotations: this.annotations
                            }
                        }
                    }
                });

                this.performanceChart = new Chart($('performanceChart'), {
                    type: 'line',
                    data: {
                        labels: this.performanceHistory.map(h => h.time),
                        datasets: [{
                            label: 'Portfolio Value',
                            data: this.performanceHistory.map(h => h.value),
                            borderColor: 'var(--accent-orange)',
                            backgroundColor: 'rgba(255, 140, 0, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        animation: { duration: 1000, easing: 'easeInOutQuad' },
                        scales: { y: { ticks: { callback: v => `$${v.toFixed(2)}` } }, x: { ticks: { maxTicksLimit: 10 } } },
                        plugins: { legend: { display: false } }
                    }
                });

                this.portfolioPie = new Chart($('portfolioPie'), {
                    type: 'pie',
                    data: {
                        labels: ['Cash'],
                        datasets: [{
                            data: [this.cash],
                            backgroundColor: ['var(--accent-cyan)', 'var(--accent-purple)', 'var(--accent-orange)', 'var(--success)']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom', labels: { color: 'var(--text-primary)' } }
                        }
                    }
                });

                document.querySelectorAll('.timeframe-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.timeframe-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.changeTimeframe(btn.dataset.timeframe);
                    });
                });
            }

            calculateEMA(period) {
                const prices = this.priceHistory.map(h => h.price);
                const k = 2 / (period + 1);
                const ema = [prices[0]];
                for (let i = 1; i < prices.length; i++) {
                    ema.push(prices[i] * k + ema[i - 1] * (1 - k));
                }
                return ema;
            }

            calculateRSI(period) {
                const prices = this.priceHistory.map(h => h.price);
                if (prices.length < period + 1) return prices.map(() => null);
                const gains = [], losses = [];
                for (let i = 1; i < prices.length; i++) {
                    const diff = prices[i] - prices[i - 1];
                    gains.push(diff > 0 ? diff : 0);
                    losses.push(diff < 0 ? -diff : 0);
                }
                let avgGain = gains.slice(0, period).reduce((a, b) => a + b, 0) / period;
                let avgLoss = losses.slice(0, period).reduce((a, b) => a + b, 0) / period;
                const rs = avgGain / avgLoss || 0;
                const rsi = [null, ...Array(period - 1).fill(null), 100 - (100 / (1 + rs))];
                for (let i = period; i < gains.length; i++) {
                    avgGain = (avgGain * (period - 1) + gains[i]) / period;
                    avgLoss = (avgLoss * (period - 1) + losses[i]) / period;
                    rsi.push(100 - (100 / (1 + (avgGain / avgLoss || 0))));
                }
                return rsi;
            }

            calculateBollingerBands(period) {
                const prices = this.priceHistory.map(h => h.price);
                const sma = prices.map((_, i) => i < period - 1 ? null : prices.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0) / period);
                const upper = [], lower = [];
                for (let i = 0; i < prices.length; i++) {
                    if (i < period - 1) {
                        upper.push(null);
                        lower.push(null);
                    } else {
                        const slice = prices.slice(i - period + 1, i + 1);
                        const mean = sma[i];
                        const stdDev = Math.sqrt(slice.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / period);
                        upper.push(mean + 2 * stdDev);
                        lower.push(mean - 2 * stdDev);
                    }
                }
                return { upper, lower };
            }

            startSimulation() {
                this.priceUpdateInterval = setInterval(() => this.updatePrice(), 15000);
                setInterval(() => this.simulateDarkPool(), 30000);
                setInterval(() => this.updateClock(), 1000);
                this.debouncedUpdateUI = debounce(this.updateUI.bind(this), 200);
                this.debouncedUpdateUI();
            }

            updateClock() {
                $('clock').textContent = formatDateTime();
            }

            async updatePrice() {
                if (this.apiCalls < this.maxApiCalls) {
                    try {
                        const symbol = this.currentStock === 'BTC' ? 'BTCUSD' : this.currentStock;
                        const res = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${this.apiKey}`);
                        if (!res.ok) throw new Error(`HTTP error: ${res.status}`);
                        const data = await res.json();
                        if (data['Global Quote'] && data['Global Quote']['05. price']) {
                            this.lastPrice = this.price;
                            this.price = parseFloat(data['Global Quote']['05. price']);
                            this.stockPrices[this.currentStock] = this.price;
                            this.isLive = true;
                            this.apiCalls++;
                            showToast(`Live price updated for ${this.currentStock}`, 'success');
                        } else {
                            throw new Error('Invalid API response: No price data');
                        }
                    } catch (e) {
                        console.error('API fetch failed:', e);
                        this.simulatePrice();
                        showToast(`Failed to fetch live data: ${e.message}. Using simulation`, 'warning');
                    }
                } else {
                    this.simulatePrice();
                    showToast('API rate limit reached, using simulation', 'warning');
                }
                this.debouncedUpdateUI();
            }

            simulatePrice() {
                this.lastPrice = this.price;
                const volatility = this.currentStock === 'BTC' ? 0.05 : 0.02;
                const change = (Math.random() - 0.5) * volatility;
                this.price *= (1 + change);
                this.price = Math.max(10, this.price.toFixed(2));
                this.stockPrices[this.currentStock] = this.price;
                this.isLive = false;
            }

            simulateDarkPool() {
                const impact = (Math.random() - 0.5) * 0.03;
                this.lastPrice = this.price;
                this.price *= (1 + impact);
                this.annotations.push({
                    type: 'line',
                    xMin: this.priceHistory.length - 1,
                    xMax: this.priceHistory.length - 1,
                    yMin: this.price * 0.95,
                    yMax: this.price * 1.05,
                    borderColor: impact > 0 ? 'var(--success)' : 'var(--danger)',
                    borderWidth: 2,
                    label: { content: 'Dark Pool', position: 'top', enabled: true, backgroundColor: 'rgba(0, 0, 0, 0.7)' }
                });
                showToast(`Dark pool trade: ${impact > 0 ? 'Buy' : 'Sell'} pressure`, impact > 0 ? 'success' : 'error');
                this.debouncedUpdateUI();
            }

            updateUI() {
                if (!this.priceChart.canvas.isIntersecting && !this.performanceChart.canvas.isIntersecting) return;

                $('currentPrice').textContent = this.price.toFixed(2);
                const change = ((this.price - this.lastPrice) / this.lastPrice * 100).toFixed(2);
                $('priceTrend').textContent = `${change > 0 ? '+' : ''}${change}%`;
                $('priceTrend').className = `price-trend ${change >= 0 ? 'trend-up' : 'trend-down'}`;
                $('liveStatus').textContent = this.isLive ? 'Live' : 'Offline';
                $('liveStatus').className = `live-indicator ${this.isLive ? 'live' : 'offline'}`;

                const volume = Math.abs(this.price - this.lastPrice) * 100 + Math.random() * 500;
                this.priceHistory.push({ time: new Date().toLocaleTimeString(), price: this.price, volume });
                if (this.priceHistory.length > 60) {
                    this.priceHistory.shift();
                    this.annotations.shift();
                }
                this.priceChart.data.labels = this.priceHistory.map(h => h.time);
                this.priceChart.data.datasets[0].data = this.priceHistory.map(h => h.price);
                this.priceChart.data.datasets[1].data = this.calculateEMA(10);
                this.priceChart.data.datasets[2].data = this.calculateRSI(14);
                const bb = this.calculateBollingerBands(20);
                this.priceChart.data.datasets[3].data = bb.upper;
                this.priceChart.data.datasets[4].data = bb.lower;
                this.priceChart.data.datasets[5].data = this.priceHistory.map(h => h.volume);
                this.priceChart.options.plugins.annotation.annotations = this.annotations;
                this.priceChart.update();

                const totalStocks = this.portfolio[this.currentStock]?.qty || 0;
                const stockValue = totalStocks * this.price;
                const totalValue = this.cash + stockValue + this.calculateShortValue();
                const profitLoss = stockValue - (this.portfolio[this.currentStock]?.totalSpent || 0);

                $('cash').textContent = this.cash.toFixed(2);
                $('stocks').textContent = totalStocks;
                $('totalValue').textContent = totalValue.toFixed(2);
                $('profitLoss').textContent = profitLoss.toFixed(2);
                $('profitLoss').style.color = profitLoss >= 0 ? 'var(--success)' : 'var(--danger)';
                this.calculateVolatility();
                this.updatePerformance(totalValue);
                this.updatePortfolioPie();
                this.updateAnalytics();
                this.updateLeaderboard();
                this.updateTradeLog();
                this.checkOrders();
            }

            calculateVolatility() {
                const prices = this.priceHistory.map(h => h.price);
                if (prices.length < 2) return $('volatility').textContent = '0.00%';
                const returns = prices.slice(1).map((p, i) => (p - prices[i]) / prices[i]);
                const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
                const variance = returns.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / returns.length;
                const vol = (Math.sqrt(variance) * Math.sqrt(252) * 100).toFixed(2);
                $('volatility').textContent = `${vol}%`;
            }

            calculateSharpeRatio() {
                const returns = this.performanceHistory.map((h, i) => i === 0 ? 0 : (h.value - this.performanceHistory[i - 1].value) / this.performanceHistory[i - 1].value);
                if (returns.length < 2) return 0;
                const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
                const stdDev = Math.sqrt(returns.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / returns.length);
                return stdDev === 0 ? 0 : (mean / stdDev * Math.sqrt(252)).toFixed(2);
            }

            updatePerformance(totalValue) {
                this.performanceHistory.push({ time: new Date().toLocaleTimeString(), value: totalValue });
                if (this.performanceHistory.length > 60) this.performanceHistory.shift();
                this.performanceChart.data.labels = this.performanceHistory.map(h => h.time);
                this.performanceChart.data.datasets[0].data = this.performanceHistory.map(h => h.value);
                this.performanceChart.update();
            }

            updatePortfolioPie() {
                const stockValues = Object.entries(this.portfolio).map(([stock, data]) => ({
                    label: stock,
                    value: data.qty * (this.stockPrices[stock] || 100)
                }));
                this.portfolioPie.data.labels = ['Cash', ...stockValues.map(s => s.label)];
                this.portfolioPie.data.datasets[0].data = [this.cash, ...stockValues.map(s => s.value)];
                this.portfolioPie.update();
            }

            updateAnalytics() {
                $('sharpeRatio').textContent = this.calculateSharpeRatio();
                const totalVotes = this.sentiment.votes.bullish + this.sentiment.votes.bearish;
                $('bullish').textContent = totalVotes ? `${(this.sentiment.votes.bullish / totalVotes * 100).toFixed(0)}%` : '50%';
                $('bearish').textContent = totalVotes ? `${(this.sentiment.votes.bearish / totalVotes * 100).toFixed(0)}%` : '50%';
            }

            updateLeaderboard() {
                const totalValue = this.cash + Object.entries(this.portfolio).reduce((sum, [s, d]) => sum + d.qty * (this.stockPrices[s] || 100), 0);
                this.leaderboard['Guest'] = totalValue;
                localStorage.setItem('leaderboard', JSON.stringify(this.leaderboard));
                const sorted = Object.entries(this.leaderboard).sort((a, b) => b[1] - a[1]).slice(0, 5);
                $('leaderboard').innerHTML = sorted.map(([user, val]) => `<div class="list-item"><span>${user}</span><span>$${val.toFixed(2)}</span></div>`).join('');
            }

            updateTradeLog() {
                $('tradeLog').innerHTML = this.tradeLog.slice(-5).map(t => 
                    `<div class="list-item"><span>${t.type} ${t.qty} ${t.stock}</span><span>$${t.price.toFixed(2)} @ ${t.time}</span></div>`
                ).join('');
            }

            handleBuy() {
                const qty = parseInt($('quantity').value);
                const type = $('orderType').value;
                const price = type === 'limit' ? parseFloat($('limitPrice').value) : type === 'stop-loss' ? parseFloat($('stopLossPrice').value) : type === 'take-profit' ? parseFloat($('takeProfitPrice').value) : this.price;
                const leverage = type === 'short' ? parseInt($('leverage').value) : 1;
                const cost = qty * price;

                if (!this.validateOrder(qty, cost, price, leverage, 'buy')) return;

                if (type === 'limit' && this.price > price) {
                    this.limitOrders.push({ type: 'buy', qty, price });
                    showToast(`Limit buy placed at $${price.toFixed(2)}`, 'info');
                } else if (type === 'stop-loss') {
                    this.stopLossOrders.push({ qty, price });
                    showToast(`Stop-loss set at $${price.toFixed(2)}`, 'info');
                } else if (type === 'take-profit') {
                    this.takeProfitOrders.push({ qty, price });
                    showToast(`Take-profit set at $${price.toFixed(2)}`, 'info');
                } else if (type === 'short') {
                    this.shortPositions.push({ qty, entryPrice: this.price, leverage, margin: cost / leverage });
                    this.cash -= cost / leverage;
                    showToast(`Short position opened: ${qty} ${this.currentStock} @ ${leverage}x`, 'info');
                    this.tradeLog.push({ type: 'Short', qty, stock: this.currentStock, price, time: new Date().toLocaleTimeString() });
                } else {
                    this.cash -= cost;
                    this.portfolio[this.currentStock] = this.portfolio[this.currentStock] || { qty: 0, totalSpent: 0 };
                    this.portfolio[this.currentStock].qty += qty;
                    this.portfolio[this.currentStock].totalSpent += cost;
                    showToast(`Bought ${qty} ${this.currentStock} for $${cost.toFixed(2)}`, 'success');
                    this.tradeLog.push({ type: 'Buy', qty, stock: this.currentStock, price, time: new Date().toLocaleTimeString() });
                }
                this.saveData();
                this.debouncedUpdateUI();
            }

            handleSell() {
                const qty = parseInt($('quantity').value);
                const type = $('orderType').value;
                const price = type === 'limit' ? parseFloat($('limitPrice').value) : type === 'stop-loss' ? parseFloat($('stopLossPrice').value) : type === 'take-profit' ? parseFloat($('takeProfitPrice').value) : this.price;
                const revenue = qty * price;

                if (!this.portfolio[this.currentStock] || this.portfolio[this.currentStock].qty < qty) {
                    showToast('Not enough stocks to sell', 'error');
                    return;
                }

                if (type === 'limit' && this.price < price) {
                    this.limitOrders.push({ type: 'sell', qty, price });
                    showToast(`Limit sell placed at $${price.toFixed(2)}`, 'info');
                } else if (type === 'stop-loss') {
                    this.stopLossOrders.push({ qty, price });
                    showToast(`Stop-loss set at $${price.toFixed(2)}`, 'info');
                } else if (type === 'take-profit') {
                    this.takeProfitOrders.push({ qty, price });
                    showToast(`Take-profit set at $${price.toFixed(2)}`, 'info');
                } else {
                    this.cash += revenue;
                    const avgCost = this.portfolio[this.currentStock].totalSpent / this.portfolio[this.currentStock].qty;
                    this.portfolio[this.currentStock].qty -= qty;
                    this.portfolio[this.currentStock].totalSpent -= avgCost * qty;
                    if (this.portfolio[this.currentStock].qty === 0) delete this.portfolio[this.currentStock];
                    showToast(`Sold ${qty} ${this.currentStock} for $${revenue.toFixed(2)}`, 'success');
                    this.tradeLog.push({ type: 'Sell', qty, stock: this.currentStock, price, time: new Date().toLocaleTimeString() });
                }
                this.saveData();
                this.debouncedUpdateUI();
            }

            validateOrder(qty, amount, price, leverage, type) {
                if (isNaN(qty) || qty <= 0 || !Number.isInteger(qty)) {
                    showToast('Quantity must be a positive integer', 'error');
                    return false;
                }
                if (isNaN(price) || price <= 0) {
                    showToast('Price must be a positive number', 'error');
                    return false;
                }
                if (type === 'short' && (isNaN(leverage) || leverage < 1 || leverage > 10)) {
                    showToast('Leverage must be between 1 and 10', 'error');
                    return false;
                }
                if (type === 'buy' && this.cash < amount) {
                    showToast('Insufficient funds', 'error');
                    return false;
                }
                return true;
            }

            checkOrders() {
                this.limitOrders = this.limitOrders.filter(o => {
                    if (o.type === 'buy' && this.price <= o.price) {
                        this.cash -= o.qty * o.price;
                        this.portfolio[this.currentStock] = this.portfolio[this.currentStock] || { qty: 0, totalSpent: 0 };
                        this.portfolio[this.currentStock].qty += o.qty;
                        this.portfolio[this.currentStock].totalSpent += o.qty * o.price;
                        this.tradeLog.push({ type: 'Buy (Limit)', qty: o.qty, stock: this.currentStock, price: o.price, time: new Date().toLocaleTimeString() });
                        notify('Limit Buy Executed', `${o.qty} ${this.currentStock} @ $${o.price.toFixed(2)}`);
                        return false;
                    } else if (o.type === 'sell' && this.price >= o.price) {
                        this.cash += o.qty * o.price;
                        const avgCost = this.portfolio[this.currentStock].totalSpent / this.portfolio[this.currentStock].qty;
                        this.portfolio[this.currentStock].qty -= o.qty;
                        this.portfolio[this.currentStock].totalSpent -= avgCost * o.qty;
                        this.tradeLog.push({ type: 'Sell (Limit)', qty: o.qty, stock: this.currentStock, price: o.price, time: new Date().toLocaleTimeString() });
                        notify('Limit Sell Executed', `${o.qty} ${this.currentStock} @ $${o.price.toFixed(2)}`);
                        return false;
                    }
                    return true;
                });

                this.stopLossOrders = this.stopLossOrders.filter(o => {
                    if (this.price <= o.price) {
                        this.cash += o.qty * this.price;
                        const avgCost = this.portfolio[this.currentStock].totalSpent / this.portfolio[this.currentStock].qty;
                        this.portfolio[this.currentStock].qty -= o.qty;
                        this.portfolio[this.currentStock].totalSpent -= avgCost * o.qty;
                        this.tradeLog.push({ type: 'Sell (Stop-Loss)', qty: o.qty, stock: this.currentStock, price: this.price, time: new Date().toLocaleTimeString() });
                        notify('Stop-Loss Triggered', `${o.qty} ${this.currentStock} @ $${this.price.toFixed(2)}`);
                        return false;
                    }
                    return true;
                });

                this.takeProfitOrders = this.takeProfitOrders.filter(o => {
                    if (this.price >= o.price) {
                        this.cash += o.qty * this.price;
                        const avgCost = this.portfolio[this.currentStock].totalSpent / this.portfolio[this.currentStock].qty;
                        this.portfolio[this.currentStock].qty -= o.qty;
                        this.portfolio[this.currentStock].totalSpent -= avgCost * o.qty;
                        this.tradeLog.push({ type: 'Sell (Take-Profit)', qty: o.qty, stock: this.currentStock, price: this.price, time: new Date().toLocaleTimeString() });
                        notify('Take-Profit Triggered', `${o.qty} ${this.currentStock} @ $${this.price.toFixed(2)}`);
                        return false;
                    }
                    return true;
                });

                this.shortPositions = this.shortPositions.filter(p => {
                    const loss = (this.price - p.entryPrice) * p.qty * p.leverage;
                    if (loss > p.margin * 0.9) {
                        this.cash -= loss;
                        this.tradeLog.push({ type: 'Short Liquidated', qty: p.qty, stock: this.currentStock, price: this.price, time: new Date().toLocaleTimeString() });
                        showToast(`Short position liquidated: Loss $${loss.toFixed(2)}`, 'error');
                        notify('Short Liquidation', `Loss: $${loss.toFixed(2)}`);
                        return false;
                    }
                    return true;
                });
            }

            calculateShortValue() {
                return this.shortPositions.reduce((sum, p) => sum + (p.entryPrice - this.price) * p.qty * p.leverage, 0);
            }

            vote(type) {
                this.sentiment.votes[type]++;
                this.updateAnalytics();
                showToast(`Voted ${type}`, 'success');
            }

            changeStock() {
                this.currentStock = $('stockSelect').value;
                this.price = this.stockPrices[this.currentStock] || 100;
                this.priceHistory = [{ time: new Date().toLocaleTimeString(), price: this.price, volume: 500 }];
                this.annotations = [];
                this.apiCalls = 0;
                this.updatePrice();
                showToast(`Switched to ${this.currentStock}`, 'info');
            }

            changeTimeframe(timeframe) {
                const intervals = { '1m': 15000, '5m': 30000, '1d': 60000 };
                clearInterval(this.priceUpdateInterval);
                this.priceUpdateInterval = setInterval(() => this.updatePrice(), intervals[timeframe]);
                showToast(`Switched to ${timeframe} timeframe`, 'info');
            }

            changeTheme() {
                const theme = $('themeSelect').value;
                document.body.className = `${theme}-theme`;
                localStorage.setItem('theme', theme);
            }

            applyTheme() {
                const theme = localStorage.getItem('theme') || 'cyberpunk';
                $('themeSelect').value = theme;
                document.body.className = `${theme}-theme`;
            }

            saveData() {
                localStorage.setItem('simulator_data', JSON.stringify({
                    cash: this.cash,
                    portfolio: this.portfolio,
                    currentStock: this.currentStock,
                    limitOrders: this.limitOrders,
                    stopLossOrders: this.stopLossOrders,
                    takeProfitOrders: this.takeProfitOrders,
                    shortPositions: this.shortPositions,
                    stockPrices: this.stockPrices,
                    sentiment: this.sentiment,
                    performanceHistory: this.performanceHistory,
                    tradeLog: this.tradeLog
                }));
                showSaveIndicator();
            }

            loadData() {
                const data = JSON.parse(localStorage.getItem('simulator_data'));
                if (data) {
                    Object.assign(this, data);
                    $('stockSelect').value = this.currentStock;
                    this.debouncedUpdateUI();
                }
            }

            exportData() {
                const data = { cash: this.cash, portfolio: this.portfolio, tradeLog: this.tradeLog };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `portfolio.json`;
                a.click();
                URL.revokeObjectURL(url);
                showToast('Portfolio exported', 'success');
            }

            importData(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        this.cash = data.cash || 10000;
                        this.portfolio = data.portfolio || {};
                        this.tradeLog = data.tradeLog || [];
                        this.saveData();
                        this.debouncedUpdateUI();
                        showToast('Portfolio imported', 'success');
                    } catch (err) {
                        showToast('Invalid file format', 'error');
                    }
                };
                reader.readAsText(file);
            }

            resetSimulator() {
                this.cash = 10000;
                this.portfolio = {};
                this.priceHistory = [{ time: new Date().toLocaleTimeString(), price: this.price, volume: 500 }];
                this.limitOrders = [];
                this.stopLossOrders = [];
                this.takeProfitOrders = [];
                this.shortPositions = [];
                this.sentiment = { bullish: 50, bearish: 50, votes: { bullish: 0, bearish: 0 } };
                this.performanceHistory = [{ time: new Date().toLocaleTimeString(), value: 10000 }];
                this.tradeLog = [];
                this.annotations = [];
                this.saveData();
                this.debouncedUpdateUI();
                showToast('Simulator reset', 'success');
            }
        }

        // Intersection Observer for Lazy Loading
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                entry.target.isIntersecting = entry.isIntersecting;
            });
        }, { threshold: 0.1 });

        // Start App
        document.addEventListener('DOMContentLoaded', () => {
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                showToast('Warning: Use HTTPS for security', 'warning');
            }
            const simulator = new StockSimulator();
            observer.observe(simulator.priceChart.canvas);
            observer.observe(simulator.performanceChart.canvas);
        });
    </script>
</body>
</html>